<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="20240806-0" author="idelcas">
        <sql>
            CREATE TABLE IF NOT EXISTS shopnow.roles
            (
            role_id BIGSERIAL NOT NULL PRIMARY KEY,
            rolename VARCHAR(255) NOT NULL
            );
        </sql>
        <rollback>
            DROP TABLE shopnow.roles;
        </rollback>
    </changeSet>

    <changeSet id="20240806-1" author="idelcas">
        <sql>
            CREATE TABLE IF NOT EXISTS shopnow.person
            (
            person_id BIGSERIAL NOT NULL PRIMARY KEY,
            dni VARCHAR(255) NOT NULL,
            fullName VARCHAR(255) NOT NULL,
            gender VARCHAR(255) ,
            phone VARCHAR(255) ,
            email VARCHAR(255) NOT NULL

            );
        </sql>
        <rollback>
            DROP TABLE shopnow.person;
        </rollback>
    </changeSet>

    <changeSet id="20240806-2" author="idelcas">
        <sql>
            CREATE TABLE IF NOT EXISTS shopnow.user_account
            (
            user_id BIGSERIAL NOT NULL PRIMARY KEY,
            user_name VARCHAR(255) NOT NULL,
            password VARCHAR(255) NOT NULL,
            person_id BIGSERIAL

            );
        </sql>
        <rollback>
            DROP TABLE shopnow.person;
        </rollback>
    </changeSet>
    <changeSet author="idelcas" id="20240806-3">
        <preConditions onFail="MARK_RAN">
            <not>
                <customPrecondition className="com.ctp.liquibase.ForeignKeyExistsPrecondition">
                    <param name="schemaName" value="shopnow"/>
                    <param name="tableName" value="user_account"/>
                    <param name="columnName" value="person_id"/>
                    <param name="foreignTableName" value="person"/>
                </customPrecondition>
            </not>
        </preConditions>

        <addForeignKeyConstraint baseColumnNames="person_id"
                                 baseTableName="user_account"
                                 baseTableSchemaName="shopnow"
                                 constraintName="fk_user_person"
                                 deferrable="true"
                                 initiallyDeferred="true"
                                 onDelete="CASCADE"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="person_id"
                                 referencedTableName="person"
                                 referencedTableSchemaName="shopnow"
        />
    </changeSet>

    <changeSet id="20240806-5" author="idelcas">
        <sql>
            CREATE TABLE IF NOT EXISTS shopnow.user_role
            (
            user_id BIGSERIAL NOT NULL,
            role_id BIGSERIAL NOT NULL

            );
        </sql>
        <rollback>
            DROP TABLE shopnow.user_role;
        </rollback>
    </changeSet>

    <changeSet author="idelcas" id="20240806-6">
        <addPrimaryKey
                columnNames="user_id, role_id"
                constraintName="pk_user_rol"
                schemaName="shopnow"
                tableName="user_role"
        />
    </changeSet>

    <changeSet author="idelcas" id="20240806-7">
        <preConditions onFail="MARK_RAN">
            <not>
                <customPrecondition className="com.ctp.liquibase.ForeignKeyExistsPrecondition">
                    <param name="schemaName" value="shopnow"/>
                    <param name="tableName" value="user_role"/>
                    <param name="columnName" value="role_id"/>
                    <param name="foreignTableName" value="roles"/>
                </customPrecondition>
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="role_id"
                                 baseTableName="user_role"
                                 baseTableSchemaName="shopnow"
                                 constraintName="fk_role_id"
                                 deferrable="true"
                                 initiallyDeferred="true"
                                 onDelete="CASCADE"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="role_id"
                                 referencedTableName="roles"
                                 referencedTableSchemaName="shopnow"
        />
    </changeSet>

    <changeSet author="idelcas" id="20240806-4">
        <preConditions onFail="MARK_RAN">
            <not>
                <customPrecondition className="com.ctp.liquibase.ForeignKeyExistsPrecondition">
                    <param name="schemaName" value="shopnow"/>
                    <param name="tableName" value="user_role"/>
                    <param name="columnName" value="user_id"/>
                    <param name="foreignTableName" value="user_account"/>
                </customPrecondition>
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="user_role"
                                 baseTableSchemaName="shopnow"
                                 constraintName="fk_user_id"
                                 deferrable="true"
                                 initiallyDeferred="true"
                                 onDelete="CASCADE"
                                 onUpdate="RESTRICT"
                                 referencedColumnNames="user_id"
                                 referencedTableName="user_account"
                                 referencedTableSchemaName="shopnow"
        />
    </changeSet>



    <changeSet id="20240806-9" author="idelcas">
        <sql>
            CREATE TABLE IF NOT EXISTS shopnow.login_attempt
            (
            id BIGSERIAL NOT NULL PRIMARY KEY,
            username VARCHAR(255) NOT NULL,
            success BOOLEAN DEFAULT false,
            created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
            );
        </sql>
        <rollback>
            DROP TABLE shopnow.login_attempt;
        </rollback>
    </changeSet>

    <changeSet id="20240806-8" author="idelcas">
        <insert tableName="roles" schemaName="shopnow">
            <column name="role_id" value="1"/>
            <column name="rolename" value="USER"/>
        </insert>
        <insert tableName="roles" schemaName="shopnow">
            <column name="role_id" value="2"/>
            <column name="rolename" value="ADMIN"/>
        </insert>
        <insert tableName="roles" schemaName="shopnow">
            <column name="role_id" value="3"/>
            <column name="rolename" value="PM"/>
        </insert>
    </changeSet>

</databaseChangeLog>
